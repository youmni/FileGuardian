name: Test PowerShell Modules with Pester

on:
  push:
    branches: [ feature/*, fix/*, improvement/*, main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
permissions:
  contents: read
  checks: write
  pull-requests: write
jobs:
  test:
    runs-on: windows-latest
    env:
      FILEGUARDIAN_CONFIG_PATH: ${{ github.workspace }}/config/backup-config.json
      FILEGUARDIAN_LOG_DIRECTORY: ${{ github.workspace }}/logs
      FILEGUARDIAN_REPORT_OUTPUT_PATH: ${{ github.workspace }}/reports
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        shell: pwsh
        run: |
          # Install CredentialManager (for Get-StoredCredential) and ensure directories exist
          Install-Module -Name CredentialManager -Force -Scope CurrentUser -AllowClobber -ErrorAction SilentlyContinue
          New-Item -Path "$env:FILEGUARDIAN_LOG_DIRECTORY" -ItemType Directory -Force | Out-Null
          New-Item -Path "$env:FILEGUARDIAN_REPORT_OUTPUT_PATH" -ItemType Directory -Force | Out-Null
          New-Item -Path "${{ github.workspace }}\backups" -ItemType Directory -Force | Out-Null

      - name: test module
        uses: zyborg/pester-tests-report@v1
        continue-on-error: true
        with:
          include_paths: tests
          exclude_tags: skip_ci
          report_name: module_tests
          report_title: Module Tests
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_passed_tests: false
          show_skipped_tests: false


      - name: dump test results (action)
        shell: pwsh
        run: |
          Write-Host 'Action - Total Executed...:  ${{ steps.test_module.outputs.total_count }}'
          Write-Host 'Action - Passed.....:  ${{ steps.test_module.outputs.passed_count }}'
          Write-Host 'Action - Failed.....:  ${{ steps.test_module.outputs.failed_count }}'